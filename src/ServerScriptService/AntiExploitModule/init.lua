local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local Modules = script.Modules

local Flag = require(Modules.Flag)
local PlayerClass = require(Modules.PlayerClass)

local Lib = script.Lib
local MaidClass = require(Lib.Maid)
local SignalClass = require(Lib.Signal)

local config = require(script.CONFIG)

local Debugger = require(Modules.Debugger)
local FLAGS_UNTIL_SUSPICIOUS = config.FlagsUntilSuspicious

local AntiExploit = {}
AntiExploit.Players = {}
AntiExploit.SuspiciousPlayers = {}
AntiExploit.Flags = {}
AntiExploit.IsRunning = false

AntiExploit.OnSuspiciousPlayerAdded = SignalClass.new()

AntiExploit.__maid = MaidClass.new()

function AntiExploit:AddPlayer(player)
    local userid = player.UserId
    
    if table.find(config.Whitelist, userid) then
        return
    end

    local obj = PlayerClass.new(player)
    self.Players[userid] = obj
    self.__maid[userid] = obj
    self.Flags[userid] = self.Flags[userid] or {}

    obj.OnFlagged:Connect(function(message)
        local flag = Flag.create(message)
        local flags = self.Flags[userid] 

        table.insert(flags, flag)
        
        if #flags > FLAGS_UNTIL_SUSPICIOUS then
            self:FlagSuspiciousPlayer(player)
        end
    end)
    Debugger.Print(string.format("[AntiExploitModule]: Added Player %s to tracked players", player.Name), 1)
end

function AntiExploit:RemovePlayer(player)
    self.Players[player.UserId] = nil
    self.__maid[player.UserId] = nil

    Debugger.Print(string.format("[AntiExploitModule]: Removed Player %s from tracked players", player.Name), 1)
end

function AntiExploit:FlagSuspiciousPlayer(player)
    if self.SuspiciousPlayers[player.UserId] then
        return
    end

    self.SuspiciousPlayers[player.UserId] = player
    self.OnSuspiciousPlayerAdded:Fire(player)
    
    Debugger.Warn(string.format("[AntiExploitModule]: Player %s is marked suspcious! They were flagged more than %d times", player.Name, FLAGS_UNTIL_SUSPICIOUS), 1)
end

function AntiExploit:Start()
    Debugger.Print("[AntiExploitModule]: Initializing AntiExploitModule", 1)

    for _, player in pairs(Players:GetPlayers()) do
        self:AddPlayer(player)
    end
    self.__maid:GiveTask(Players.PlayerAdded:Connect(function(player)
        self:AddPlayer(player)
    end))
    self.__maid:GiveTask(Players.PlayerRemoving:Connect(function(player)
        self:RemovePlayer(player)
    end))

    self.__maid:GiveTask(RunService.PostSimulation:Connect(function()
        for _, player in pairs(self.Players) do
            player:Step()
        end
    end))
end

function AntiExploit:Stop()
   Debugger.Print("[AntiExploitModule]: STOPPING AntiExploitModule", 1)

    self.__maid:DoCleaning()
end

return AntiExploit