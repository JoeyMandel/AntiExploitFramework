local RootFolder = script.Parent.Parent.Parent
local Config = require(RootFolder.CONFIG)

local Debugger = require(RootFolder.Modules.Debugger)

local SPEED_TOLERANCE = Config.SpeedTolerance

local SpeedCheck = {}

function SpeedCheck.Check(playerObj)
	local physicsInfo = playerObj.PhysicsInfo
	local characterInfo = playerObj.CharacterInfo

	local humanoid = characterInfo.Humanoid
	local player = playerObj.Player

	local passed = true
	local returnMessage = ""
		
	local distance = math.floor(((physicsInfo.CurrentCFrame.Position - physicsInfo.LastCFrame.Position) * Vector3.new(1,0,1)).Magnitude)
	local deltaTime = (tick() - physicsInfo.LastStepped)
	local horizontalSpeed = distance/deltaTime

	local speedTolerance = humanoid.WalkSpeed + SPEED_TOLERANCE
	
	if horizontalSpeed >= speedTolerance then
		passed = false
		physicsInfo.SkipNextStep = true
		Debugger.Print(
			string.format("[SpeedExploitChecker]: %s has travelled %e studs in %e seconds", playerObj.Player.Name, distance, deltaTime),
			2
		)
		returnMessage = string.format("%s was going too fast...: %d sps", player.Name, horizontalSpeed)
	end

	return passed, returnMessage
end

function SpeedCheck.Punish(playerObj)
	local characterInfo = playerObj.CharacterInfo
	characterInfo.CharacterModel:SetPrimaryPartCFrame(playerObj.PhysicsInfo.LastCFrame)
end

return SpeedCheck
